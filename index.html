<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Registro de Pacientes - Hospital</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!-- Banner de publicidad -->
    <div
      id="bannerPublicidad"
      style="
        background: #ffe066;
        color: #333;
        padding: 15px;
        text-align: center;
        font-size: 18px;
        position: relative;
      "
    >
      <span>
        ¬°Consulta nuestros nuevos servicios de salud!
        <a
          href="https://www.hospitalpuebla.com.mx/"
          target="_blank"
          style="color: #007bff; text-decoration: underline"
          >M√°s informaci√≥n</a
        >
      </span>
      <button
        id="cerrarPublicidad"
        style="
          position: absolute;
          right: 15px;
          top: 10px;
          background: none;
          border: none;
          font-size: 20px;
          cursor: pointer;
        "
      >
        &times;
      </button>
    </div>

    <!-- Banner de publicidad lateral -->
    <div
      id="bannerLateralPublicidad"
      style="
        position: fixed;
        top: 100px;
        right: 0;
        width: 120px;
        background: #fffbe6;
        border-left: 2px solid #ffe066;
        text-align: center;
        padding: 10px 0;
        z-index: 9999;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.07);
        border-radius: 10px 0 0 10px;
      "
    >
      <a
        href="https://www.fahorro.com/"
        target="_blank"
        style="display: inline-block"
      >
        <img
          src="farmacia.png"
          alt="Publicidad farmacia"
          style="height: 100px; vertical-align: middle"
        />
      </a>
    </div>

    <div class="container">
      <div class="header">
        <h1>üè• Sistema Hospitalario</h1>
        <p>Gesti√≥n Integral de Pacientes</p>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="registro">
          üìù Registro de Pacientes
        </button>
        <button class="nav-tab" data-tab="lista">üë• Lista de Pacientes</button>
        <button class="nav-tab" data-tab="estadisticas">üìä Estad√≠sticas</button>
      </div>

      <div id="registro" class="tab-content active">
        <h2 style="color: #2c3e50; margin-bottom: 25px">
          Registro de Nuevo Paciente
        </h2>

        <form id="formPaciente">
          <div class="form-row">
            <div class="form-group">
              <label for="nombre">Nombre Completo *</label>
              <input type="text" id="nombre" name="nombre" required />
            </div>
            <div class="form-group">
              <label for="edad">Edad *</label>
              <input
                type="number"
                id="edad"
                name="edad"
                min="0"
                max="120"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="genero">G√©nero</label>
              <select id="genero" name="genero">
                <option value="">Seleccionar...</option>
                <option value="masculino">Masculino</option>
                <option value="femenino">Femenino</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label for="telefono">Tel√©fono</label>
              <input type="tel" id="telefono" name="telefono" />
            </div>
          </div>

          <div class="form-group">
            <label for="direccion">Direcci√≥n</label>
            <textarea id="direccion" name="direccion" rows="2"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="fechaIngreso">Fecha de Ingreso *</label>
              <input
                type="date"
                id="fechaIngreso"
                name="fechaIngreso"
                required
              />
            </div>
            <div class="form-group">
              <label for="departamento">Departamento *</label>
              <select id="departamento" name="departamento" required>
                <option value="">Seleccionar...</option>
                <option value="emergencias">Emergencias</option>
                <option value="medicina-general">Medicina General</option>
                <option value="cirugia">Cirug√≠a</option>
                <option value="pediatria">Pediatr√≠a</option>
                <option value="ginecologia">Ginecolog√≠a</option>
                <option value="cardiologia">Cardiolog√≠a</option>
                <option value="neurologia">Neurolog√≠a</option>
                <option value="oncologia">Oncolog√≠a</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="diagnostico">Diagn√≥stico Inicial</label>
            <textarea
              id="diagnostico"
              name="diagnostico"
              rows="3"
              placeholder="Descripci√≥n del diagn√≥stico inicial..."
            ></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="medico">M√©dico Responsable</label>
              <input
                type="text"
                id="medico"
                name="medico"
                placeholder="Dr. Nombre Apellido"
              />
            </div>
            <div class="form-group">
              <label for="seguro">Seguro M√©dico</label>
              <select id="seguro" name="seguro">
                <option value="">Seleccionar...</option>
                <option value="imss">IMSS</option>
                <option value="issste">ISSSTE</option>
                <option value="privado">Seguro Privado</option>
                <option value="particular">Particular</option>
              </select>
            </div>
          </div>

          <div style="text-align: center; margin-top: 30px">
            <button type="submit" class="btn btn-primary">
              üíæ Registrar Paciente
            </button>
            <button
              type="reset"
              class="btn"
              style="background: #6c757d; color: white; margin-left: 10px"
            >
              üîÑ Limpiar Formulario
            </button>
          </div>
        </form>

        <div id="mensajeRegistro"></div>
      </div>

      <div id="lista" class="tab-content">
        <h2 style="color: #2c3e50; margin-bottom: 25px">Lista de Pacientes</h2>

        <input
          type="text"
          id="buscarPaciente"
          class="search-box"
          placeholder="üîç Buscar paciente por nombre, ID o departamento..."
        />

        <div id="listaPacientes"></div>
      </div>

      <div id="estadisticas" class="tab-content">
        <h2 style="color: #2c3e50; margin-bottom: 25px">
          Estad√≠sticas del Hospital
        </h2>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalPacientes">0</div>
            <div class="stat-label">Total Pacientes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pacientesActivos">0</div>
            <div class="stat-label">Pacientes Activos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="altasHoy">0</div>
            <div class="stat-label">Altas Hoy</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="promedioDias">0</div>
            <div class="stat-label">Promedio D√≠as</div>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-title">Distribuci√≥n por Departamentos</div>
          <canvas id="chartDepartamentos" class="chart-canvas"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-title">Ingresos por Mes</div>
          <canvas id="chartIngresos" class="chart-canvas"></canvas>
        </div>
      </div>
    </div>

    <!-- Anuncio emergente -->
    <div
      id="popupPublicidad"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 10000;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: #fffbe6;
          border: 2px solid #ffe066;
          border-radius: 12px;
          padding: 32px 40px;
          text-align: center;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
          font-size: 20px;
          color: #333;
          max-width: 90vw;
        "
      >
        <strong>¬°Oferta especial en check-ups m√©dicos!</strong><br />
        Agenda tu cita y recibe un 10% de descuento.<br />
        <a
          href="https://www.hospitalpuebla.com.mx/"
          target="_blank"
          style="color: #007bff; text-decoration: underline"
          >Ver detalles</a
        >
      </div>
    </div>

    <script>
      // Sistema de gesti√≥n de pacientes
      class HospitalSystem {
        constructor() {
          this.pacientes = JSON.parse(
            localStorage.getItem("pacientes") || "[]"
          );
          this.contadorId = parseInt(localStorage.getItem("contadorId") || "1");
          this.charts = {};
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.setupInitialData();
          $("#fechaIngreso").val(new Date().toISOString().split("T")[0]);
        }

        setupEventListeners() {
          // Navegaci√≥n entre tabs
          $(".nav-tab").click((e) => {
            const tabId = $(e.target).data("tab");
            this.switchTab(tabId);
          });

          // Registro de pacientes
          $("#formPaciente").submit((e) => {
            e.preventDefault();
            this.registrarPaciente();
          });

          // B√∫squeda de pacientes
          $("#buscarPaciente").on("input", (e) => {
            const termino = $(e.target).val().toLowerCase();
            this.buscarPacientes(termino);
          });
        }

        switchTab(tabId) {
          $(".nav-tab").removeClass("active");
          $(".tab-content").removeClass("active");

          $(`[data-tab="${tabId}"]`).addClass("active");
          $(`#${tabId}`).addClass("active");

          if (tabId === "lista") {
            this.mostrarListaPacientes();
          } else if (tabId === "estadisticas") {
            setTimeout(() => this.actualizarEstadisticas(), 100);
          }
        }

        registrarPaciente() {
          const paciente = {
            id: this.contadorId++,
            nombre: $("#nombre").val(),
            edad: parseInt($("#edad").val()),
            genero: $("#genero").val(),
            telefono: $("#telefono").val(),
            direccion: $("#direccion").val(),
            fechaIngreso: $("#fechaIngreso").val(),
            departamento: $("#departamento").val(),
            diagnostico: $("#diagnostico").val(),
            medico: $("#medico").val(),
            seguro: $("#seguro").val(),
            estado: "activo",
            fechaRegistro: new Date().toISOString(),
          };

          this.pacientes.push(paciente);
          this.guardarDatos();

          this.mostrarMensaje(
            `¬°Paciente registrado exitosamente! ID: ${paciente.id}`,
            "success"
          );
          $("#formPaciente")[0].reset();
          $("#fechaIngreso").val(new Date().toISOString().split("T")[0]);
        }

        buscarPacientes(termino) {
          const pacientesFiltrados = this.pacientes.filter(
            (p) =>
              p.nombre.toLowerCase().includes(termino) ||
              p.id.toString().includes(termino) ||
              p.departamento.toLowerCase().includes(termino)
          );
          this.mostrarListaPacientes(pacientesFiltrados);
        }

        mostrarListaPacientes(lista = this.pacientes) {
          const container = $("#listaPacientes");
          container.empty();

          if (lista.length === 0) {
            container.html(
              '<div class="alert alert-info">No se encontraron pacientes.</div>'
            );
            return;
          }

          lista.forEach((paciente) => {
            const estadoBadge =
              paciente.estado === "activo"
                ? '<span class="status-badge status-activo">Activo</span>'
                : '<span class="status-badge status-alta">Alta</span>';

            const diasHospitalizacion = this.calcularDiasHospitalizacion(
              paciente.fechaIngreso,
              paciente.fechaAlta
            );

            const card = `
                        <div class="patient-card">
                            <div class="patient-header">
                                <div class="patient-name">${
                                  paciente.nombre
                                }</div>
                                <div class="patient-id">ID: ${paciente.id}</div>
                            </div>
                            
                            <div class="patient-info">
                                <div class="info-item">
                                    <div class="info-label">Edad</div>
                                    <div class="info-value">${
                                      paciente.edad
                                    } a√±os</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Departamento</div>
                                    <div class="info-value">${
                                      paciente.departamento
                                    }</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">M√©dico</div>
                                    <div class="info-value">${
                                      paciente.medico || "No asignado"
                                    }</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">D√≠as Hospitalizado</div>
                                    <div class="info-value">${diasHospitalizacion} d√≠as</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                ${estadoBadge}
                                <div>
                                    ${
                                      paciente.estado === "activo"
                                        ? `<button class="btn btn-success" onclick="hospitalSystem.darAlta(${paciente.id})">üìã Dar Alta</button>`
                                        : `<span style="color: #28a745; font-weight: 600;">Alta: ${this.formatearFecha(
                                            paciente.fechaAlta
                                          )}</span>`
                                    }
                                    <button class="btn btn-danger" onclick="hospitalSystem.eliminarPaciente(${
                                      paciente.id
                                    })" style="margin-left: 10px;">üóëÔ∏è Eliminar</button>
                                </div>
                            </div>
                        </div>
                    `;
            container.append(card);
          });
        }

        actualizarEstadisticas() {
          const total = this.pacientes.length;
          const activos = this.pacientes.filter(
            (p) => p.estado === "activo"
          ).length;
          const altasHoy = this.pacientes.filter((p) => {
            if (!p.fechaAlta) return false;
            const hoy = new Date().toISOString().split("T")[0];
            return p.fechaAlta === hoy;
          }).length;

          const promedioEstancia = this.calcularPromedioEstancia();

          $("#totalPacientes").text(total);
          $("#pacientesActivos").text(activos);
          $("#altasHoy").text(altasHoy);
          $("#promedioDias").text(promedioEstancia);

          this.crearGraficos();
        }

        crearGraficos() {
          this.crearGraficoDepartamentos();
          this.crearGraficoIngresos();
        }

        crearGraficoDepartamentos() {
          const canvas = document.getElementById("chartDepartamentos");
          if (!canvas) return;

          if (this.charts.departamentos) {
            this.charts.departamentos.destroy();
          }

          const departamentos = {};
          this.pacientes.forEach((p) => {
            const dept = p.departamento || "Sin departamento";
            departamentos[dept] = (departamentos[dept] || 0) + 1;
          });

          if (Object.keys(departamentos).length === 0) {
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "16px Segoe UI";
            ctx.textAlign = "center";
            ctx.fillStyle = "#6c757d";
            ctx.fillText(
              "No hay datos para mostrar",
              canvas.width / 2,
              canvas.height / 2
            );
            return;
          }

          this.charts.departamentos = new Chart(canvas, {
            type: "doughnut",
            data: {
              labels: Object.keys(departamentos).map(
                (dept) =>
                  dept.charAt(0).toUpperCase() + dept.slice(1).replace("-", " ")
              ),
              datasets: [
                {
                  data: Object.values(departamentos),
                  backgroundColor: [
                    "#FF6384",
                    "#36A2EB",
                    "#FFCE56",
                    "#4BC0C0",
                    "#9966FF",
                    "#FF9F40",
                    "#FF6B6B",
                    "#4ECDC4",
                  ],
                  borderWidth: 2,
                  borderColor: "#fff",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                },
              },
            },
          });
        }

        crearGraficoIngresos() {
          const canvas = document.getElementById("chartIngresos");
          if (!canvas) return;

          if (this.charts.ingresos) {
            this.charts.ingresos.destroy();
          }

          const ingresosPorMes = {};
          this.pacientes.forEach((p) => {
            if (p.fechaIngreso) {
              const fecha = new Date(p.fechaIngreso);
              const mes = fecha.toLocaleDateString("es-ES", {
                month: "short",
                year: "numeric",
              });
              ingresosPorMes[mes] = (ingresosPorMes[mes] || 0) + 1;
            }
          });

          if (Object.keys(ingresosPorMes).length === 0) {
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "16px Segoe UI";
            ctx.textAlign = "center";
            ctx.fillStyle = "#6c757d";
            ctx.fillText(
              "No hay datos para mostrar",
              canvas.width / 2,
              canvas.height / 2
            );
            return;
          }

          const mesesOrdenados = Object.keys(ingresosPorMes).sort((a, b) => {
            return new Date(a) - new Date(b);
          });

          this.charts.ingresos = new Chart(canvas, {
            type: "line",
            data: {
              labels: mesesOrdenados,
              datasets: [
                {
                  label: "N√∫mero de Ingresos",
                  data: mesesOrdenados.map((mes) => ingresosPorMes[mes]),
                  borderColor: "#007bff",
                  backgroundColor: "rgba(0, 123, 255, 0.1)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                  },
                },
              },
            },
          });
        }

        darAlta(id) {
          const paciente = this.pacientes.find((p) => p.id === id);
          if (paciente) {
            paciente.estado = "alta";
            paciente.fechaAlta = new Date().toISOString().split("T")[0];
            this.guardarDatos();
            this.mostrarListaPacientes();
            this.mostrarMensaje(
              `Alta m√©dica registrada para ${paciente.nombre}`,
              "success"
            );
          }
        }

        eliminarPaciente(id) {
          if (confirm("¬øEst√° seguro de que desea eliminar este paciente?")) {
            this.pacientes = this.pacientes.filter((p) => p.id !== id);
            this.guardarDatos();
            this.mostrarListaPacientes();
            this.mostrarMensaje("Paciente eliminado correctamente", "success");
          }
        }

        calcularDiasHospitalizacion(fechaIngreso, fechaAlta = null) {
          const ingreso = new Date(fechaIngreso);
          const fin = fechaAlta ? new Date(fechaAlta) : new Date();
          const diferencia = fin - ingreso;
          return Math.max(0, Math.ceil(diferencia / (1000 * 60 * 60 * 24)));
        }

        calcularPromedioEstancia() {
          if (this.pacientes.length === 0) return 0;

          const totalDias = this.pacientes.reduce((sum, p) => {
            return (
              sum +
              this.calcularDiasHospitalizacion(p.fechaIngreso, p.fechaAlta)
            );
          }, 0);

          return Math.round(totalDias / this.pacientes.length);
        }

        formatearFecha(fecha) {
          return new Date(fecha).toLocaleDateString("es-ES");
        }

        mostrarMensaje(mensaje, tipo) {
          const clase = tipo === "success" ? "alert-success" : "alert-error";
          const html = `<div class="alert ${clase}">${mensaje}</div>`;
          $("#mensajeRegistro").html(html);

          setTimeout(() => {
            $("#mensajeRegistro").empty();
          }, 5000);
        }

        guardarDatos() {
          localStorage.setItem("pacientes", JSON.stringify(this.pacientes));
          localStorage.setItem("contadorId", this.contadorId.toString());
        }

        setupInitialData() {
          if (this.pacientes.length === 0) {
            const ejemplos = [
              {
                id: 1,
                nombre: "Mar√≠a Gonz√°lez L√≥pez",
                edad: 45,
                genero: "femenino",
                telefono: "555-0123",
                direccion: "Av. Reforma 123, Ciudad de M√©xico",
                fechaIngreso: "2025-05-20",
                departamento: "cardiologia",
                diagnostico: "Hipertensi√≥n arterial - Control y seguimiento",
                medico: "Dr. Carlos Ram√≠rez",
                seguro: "imss",
                estado: "activo",
                fechaRegistro: "2025-05-20T10:30:00.000Z",
              },
              {
                id: 2,
                nombre: "Juan P√©rez Mart√≠nez",
                edad: 32,
                genero: "masculino",
                telefono: "555-0456",
                direccion: "Calle 5 de Mayo 456, Puebla",
                fechaIngreso: "2025-04-19",
                departamento: "emergencias",
                diagnostico: "Fractura de tibia - Requiere cirug√≠a",
                medico: "Dra. Ana Herrera",
                seguro: "privado",
                estado: "activo",
                fechaRegistro: "2025-04-19T15:45:00.000Z",
              },
              {
                id: 3,
                nombre: "Sof√≠a Mendoza Garc√≠a",
                edad: 28,
                genero: "femenino",
                telefono: "555-0789",
                direccion: "Col. Centro, Calle Ju√°rez 789",
                fechaIngreso: "2025-05-18",
                departamento: "ginecologia",
                diagnostico: "Control prenatal - Embarazo de 32 semanas",
                medico: "Dr. Luis Morales",
                seguro: "issste",
                estado: "alta",
                fechaAlta: "2025-05-21",
                fechaRegistro: "2025-05-18T09:15:00.000Z",
              },
              {
                id: 4,
                nombre: "Roberto Silva Cruz",
                edad: 67,
                genero: "masculino",
                telefono: "555-0321",
                direccion: "Fraccionamiento Las Flores 321",
                fechaIngreso: "2025-05-17",
                departamento: "medicina-general",
                diagnostico: "Diabetes tipo 2 - Descompensaci√≥n",
                medico: "Dra. Patricia L√≥pez",
                seguro: "imss",
                estado: "activo",
                fechaRegistro: "2025-05-17T14:20:00.000Z",
              },
              {
                id: 5,
                nombre: "Elena Rodr√≠guez Vega",
                edad: 55,
                genero: "femenino",
                telefono: "555-0654",
                direccion: "Av. Universidad 654, Puebla",
                fechaIngreso: "2025-05-16",
                departamento: "neurologia",
                diagnostico: "Migra√±a cr√≥nica - Tratamiento especializado",
                medico: "Dr. Fernando Castillo",
                seguro: "particular",
                estado: "activo",
                fechaRegistro: "2025-05-16T11:30:00.000Z",
              },
            ];

            this.pacientes = ejemplos;
            this.contadorId = 6;
            this.guardarDatos();
          }
        }
      }

      $(document).ready(function () {
        window.hospitalSystem = new HospitalSystem();

        // Publicidad con jQuery
        $("#cerrarPublicidad").click(function () {
          $("#bannerPublicidad").slideUp();
        });

        // Mostrar popup publicitario al cargar y ocultar despu√©s de 3 segundos
        $("#popupPublicidad").fadeIn(400, function () {
          setTimeout(function () {
            $("#popupPublicidad").fadeOut(400);
          }, 3000);
        });
      });
    </script>
  </body>
</html>
